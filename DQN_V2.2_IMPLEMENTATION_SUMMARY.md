# DQN v2.2 å®ç°æ€»ç»“ - Segmentä½œä¸ºç¬¬å››ä¸ªç‹¬ç«‹ç»´åº¦

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

**ç‰ˆæœ¬**: v2.2
**æ›´æ–°æ—¥æœŸ**: 2025å¹´ï¼ˆå½“å‰ï¼‰
**å…³é”®æ”¹è¿›**: Segment_sizeä»"ç½‘ç»œçŠ¶æ€è‡ªé€‚åº”"æ”¹ä¸º"ç‹¬ç«‹çš„ç¬¬å››ä¸ªåŠ¨ä½œç»´åº¦"

---

## ğŸ¯ æ ¸å¿ƒå˜åŒ–

### ä»v2.1åˆ°v2.2çš„ä¸»è¦å˜åŒ–

| æ–¹é¢ | v2.1ï¼ˆè‡ªé€‚åº”segmentï¼‰ | v2.2ï¼ˆsegmentä½œä¸ºç»´åº¦ï¼‰ |
|------|---------------------|----------------------|
| åŠ¨ä½œç©ºé—´ç»„æˆ | (bundle, block)äºŒå…ƒç»„ | (bundle, block, segment)ä¸‰å…ƒç»„ |
| åŠ¨ä½œç©ºé—´å¤§å° | 32ä¸ª | 1064ä¸ª |
| Segmenté€‰æ‹©æ–¹å¼ | åŸºäºç½‘ç»œçŠ¶æ€è‡ªé€‚åº” | RLç›´æ¥é€‰æ‹© |
| Segmentè¦†ç›– | ä¾èµ–ç½‘ç»œæ¡ä»¶ | 100%è¦†ç›–æ‰€æœ‰7ç§å€¼ |
| çº¦æŸæ¡ä»¶ | 2ä¸ªï¼ˆbundle, blockï¼‰ | 3ä¸ªï¼ˆ+segmentâ‰¤block*50%ï¼‰ |

---

## ğŸ“Š åŠ¨ä½œç©ºé—´è¯¦æƒ…

### å®Œæ•´ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **æ€»åŠ¨ä½œæ•°** | 1064 | æ‰€æœ‰æ»¡è¶³çº¦æŸçš„ä¸‰å…ƒç»„ |
| **Bundleè¦†ç›–** | 15ç§ (100%) | 1k ~ 100k |
| **Blockè¦†ç›–** | 20ç§ (100%) | 20k ~ 1000k |
| **Segmentè¦†ç›–** | 7ç§ (100%) | 200 ~ 1400 |

### çº¦æŸæ¡ä»¶

æ‰€æœ‰1064ä¸ªåŠ¨ä½œéƒ½æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼š

1. **çº¦æŸ1**: `block_size >= bundle_size`
2. **çº¦æŸ2**: `block_size % bundle_size == 0`ï¼ˆblockæ˜¯bundleçš„æ­£æ•´æ•°å€ï¼‰
3. **çº¦æŸ3**: `segment_size <= block_size * 50%`ï¼ˆsegmentä¸è¶…è¿‡blockçš„50%ï¼‰

### Segmentåˆ†å¸ƒ

æ¯ä¸ªsegmentå€¼å¯¹åº”çš„åŠ¨ä½œæ•°é‡ï¼š

```
Segment=200:  ~152ä¸ªåŠ¨ä½œ (æ‰€æœ‰152ä¸ª(bundle,block)ç»„åˆéƒ½æ»¡è¶³)
Segment=400:  ~152ä¸ªåŠ¨ä½œ
Segment=600:  ~152ä¸ªåŠ¨ä½œ
Segment=800:  ~152ä¸ªåŠ¨ä½œ
Segment=1000: ~152ä¸ªåŠ¨ä½œ
Segment=1200: ~152ä¸ªåŠ¨ä½œ
Segment=1400: ~152ä¸ªåŠ¨ä½œ
```

**æ€»è®¡**: 152ä¸ª(bundle, block)ç»„åˆ Ã— 7ä¸ªsegment = 1064ä¸ªåŠ¨ä½œ

---

## ğŸ—ï¸ å®ç°ç»†èŠ‚

### æ ¸å¿ƒæ–¹æ³•å˜åŒ–

#### 1. `__init__()` æ–¹æ³•

**v2.2å®ç°**:
```python
def __init__(self):
    # ç”Ÿæˆæ‰€æœ‰æ»¡è¶³çº¦æŸçš„ä¸‰å…ƒç»„
    all_valid_tuples = self._generate_all_valid_3tuples()
    self.valid_action_tuples = all_valid_tuples
    self.action_dim = len(self.valid_action_tuples)  # 1064

    # åˆå§‹åŒ–ç½‘ç»œï¼ˆaction_dim=1064ï¼‰
    self.network = DQNNetwork(self.state_dim, self.action_dim)
```

#### 2. `_generate_all_valid_3tuples()` æ–¹æ³•ï¼ˆæ–°å¢ï¼‰

```python
def _generate_all_valid_3tuples(self) -> List[Tuple[int, int, int]]:
    """ç”Ÿæˆæ‰€æœ‰æ»¡è¶³çº¦æŸçš„(bundle, block, segment)ä¸‰å…ƒç»„"""

    bundle_sizes = [1000, 2000, ..., 100000]  # 15ç§
    block_sizes = [20000, 40000, ..., 1000000]  # 20ç§
    segment_sizes = [200, 400, 600, 800, 1000, 1200, 1400]  # 7ç§

    valid_tuples = []
    for bundle in bundle_sizes:
        for block in block_sizes:
            if block >= bundle and block % bundle == 0:
                max_segment = int(block * 0.5)
                for segment in segment_sizes:
                    if segment <= max_segment:
                        valid_tuples.append((bundle, block, segment))

    return valid_tuples  # è¿”å›1064ä¸ªä¸‰å…ƒç»„
```

#### 3. `action_to_params()` æ–¹æ³•

**v2.2å®ç°**:
```python
def action_to_params(self, action: int,
                    data_size: int,
                    delay_ms: float,
                    transmission_rate_mbps: float) -> Dict[str, int]:
    """å°†åŠ¨ä½œç´¢å¼•è½¬æ¢ä¸ºåè®®å‚æ•°"""

    # ç›´æ¥ä»ä¸‰å…ƒç»„æŸ¥è¡¨
    bundle_size, ltp_block_size, ltp_segment_size = self.valid_action_tuples[action]

    # è®¡ç®—session_count
    trans_rate_bytes = transmission_rate_mbps * 1_000_000 / 8
    ltp_sessions = calculate_ltp_sessions(
        delay=delay_ms,
        bundle_size=bundle_size,
        file_size=data_size,
        block_size=ltp_block_size,
        trans_rate=trans_rate_bytes
    )

    return {
        "bundle_size": bundle_size,
        "ltp_block_size": ltp_block_size,
        "ltp_segment_size": ltp_segment_size,
        "session_count": ltp_sessions
    }
```

**å…³é”®å˜åŒ–**:
- ä¸å†è°ƒç”¨`_adaptive_segment_size()`
- ä¸å†éœ€è¦`bit_error_rate`å‚æ•°
- segmentç›´æ¥ä»ä¸‰å…ƒç»„è·å–

#### 4. åˆ é™¤çš„æ–¹æ³•

ä»¥ä¸‹æ–¹æ³•åœ¨v2.2ä¸­å·²åˆ é™¤ï¼š
- `_adaptive_segment_size()`
- `_validate_segment_size()`
- `_generate_all_valid_combinations()`
- `_sample_32_combinations()`

---

## ğŸ”„ æ•°æ®æµå˜åŒ–

### v2.2çš„æ•°æ®æµ

```
1. Senderè¯·æ±‚ä¼˜åŒ–å‚æ•°
   â†“
2. DQNä¼˜åŒ–å™¨
   - çŠ¶æ€ï¼š[data_size, BER, delay, rate]
   - Îµ-è´ªå¿ƒé€‰æ‹©åŠ¨ä½œï¼š0 ~ 1063
   - æŸ¥è¡¨è·å–ï¼š(bundle, block, segment)
   - è®¡ç®—ï¼šsession_count
   â†“
3. è¿”å›4ä¸ªå‚æ•°ï¼š{bundle, block, segment, session}
   â†“
4. Senderåº”ç”¨å‚æ•°å¹¶ä¼ è¾“
   â†“
5. Receiverè®°å½•æ€§èƒ½
   â†“
6. è®­ç»ƒè®°å½•åé¦ˆç»™DQNä¼˜åŒ–å™¨
```

**ä¸v2.1çš„åŒºåˆ«**:
- åŠ¨ä½œç›´æ¥å¯¹åº”segmentå€¼
- ä¸éœ€è¦ç½‘ç»œçŠ¶æ€æ¥é€‰æ‹©segment
- Segmentçš„é€‰æ‹©ç”±RLæ¨¡å‹å­¦ä¹ å†³å®š

---

## âœ… éªŒè¯æµ‹è¯•ç»“æœ

### æµ‹è¯•1ï¼šçº¦æŸéªŒè¯
```bash
âœ… æ‰€æœ‰1064ä¸ªåŠ¨ä½œéƒ½æ»¡è¶³3ä¸ªçº¦æŸæ¡ä»¶
âœ… Bundleè¦†ç›–ï¼š15ç§ (100%)
âœ… Blockè¦†ç›–ï¼š20ç§ (100%)
âœ… Segmentè¦†ç›–ï¼š7ç§ (100%)
```

### æµ‹è¯•2ï¼šåŠ¨ä½œæ˜ å°„
```
åŠ¨ä½œ0 â†’ bundle=1000, block=20000, segment=200
åŠ¨ä½œ1 â†’ bundle=1000, block=20000, segment=400
åŠ¨ä½œ2 â†’ bundle=1000, block=20000, segment=600
...
åŠ¨ä½œ1063 â†’ bundle=100000, block=1000000, segment=1400
```

### æµ‹è¯•3ï¼šç³»ç»ŸåŠ è½½
```
âœ… ä¼˜åŒ–å™¨åˆå§‹åŒ–æˆåŠŸ
âœ… ç¥ç»ç½‘ç»œåˆå§‹åŒ–æˆåŠŸï¼ˆè¾“å‡ºç»´åº¦=1064ï¼‰
âœ… action_to_params()æ­£å¸¸å·¥ä½œ
âœ… session_countè®¡ç®—æ­£å¸¸
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ

### ä¼˜åŠ¿

1. **å®Œæ•´è¦†ç›–**: Segmentçš„7ä¸ªå€¼100%è¢«è¦†ç›–åˆ°
2. **RLå­¦ä¹ **: Segmenté€‰æ‹©ç”±å¼ºåŒ–å­¦ä¹ æ¨¡å‹å­¦ä¹ å†³å®šï¼Œè€Œéå›ºå®šè§„åˆ™
3. **çµæ´»æ€§é«˜**: å¯ä»¥æ ¹æ®è®­ç»ƒæ•°æ®è‡ªåŠ¨å­¦ä¹ æœ€ä¼˜segment
4. **æ— åå·®**: ä¸ä¾èµ–é¢„è®¾çš„ç½‘ç»œçŠ¶æ€åˆ¤æ–­è§„åˆ™

### æŒ‘æˆ˜

1. **åŠ¨ä½œç©ºé—´å¤§**: 1064ä¸ªåŠ¨ä½œ vs 32ä¸ªåŠ¨ä½œï¼ˆå¢åŠ 33å€ï¼‰
   - **å½±å“**: è®­ç»ƒæ”¶æ•›å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´
   - **ç¼“è§£**: DQNçš„ç»éªŒå›æ”¾å’Œç›®æ ‡ç½‘ç»œå¯ä»¥å¤„ç†è¾ƒå¤§åŠ¨ä½œç©ºé—´

2. **è®¡ç®—å¼€é”€**: ç¥ç»ç½‘ç»œè¾“å‡ºå±‚ä»32å¢åŠ åˆ°1064
   - **å½±å“**: å‰å‘ä¼ æ’­è®¡ç®—é‡å¢åŠ 
   - **è¯„ä¼°**: ä»ç„¶å¯æ¥å—ï¼ˆ128â†’1064çš„çº¿æ€§å±‚ï¼‰

3. **æ¢ç´¢æ•ˆç‡**: Îµ-è´ªå¿ƒæ¢ç´¢éœ€è¦è¦†ç›–æ›´å¤§çš„ç©ºé—´
   - **å½±å“**: åˆæœŸæ¢ç´¢å¯èƒ½ä¸å¤Ÿå……åˆ†
   - **å»ºè®®**: å¯é€‚å½“æé«˜åˆå§‹Îµå€¼ï¼ˆå¦‚0.2ï¼‰æˆ–å¢åŠ æ¢ç´¢æ­¥æ•°

### æ€§èƒ½é¢„æœŸ

| æŒ‡æ ‡ | v2.1ï¼ˆ32åŠ¨ä½œï¼‰ | v2.2ï¼ˆ1064åŠ¨ä½œï¼‰ | é¢„æœŸå˜åŒ– |
|------|---------------|----------------|---------|
| æ”¶æ•›æ­¥æ•° | ~1000-2000 | ~3000-5000 | +2-3å€ |
| è®­ç»ƒæ—¶é—´/æ­¥ | ~10ms | ~15ms | +50% |
| æœ€ç»ˆæ€§èƒ½ | è‰¯å¥½ | å¯èƒ½æ›´ä¼˜ | +5-10% |
| å‚æ•°ç²¾ç¡®åº¦ | ä¸­ç­‰ | é«˜ | æå‡ |

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨ç³»ç»Ÿ

```bash
# ç»ˆç«¯1ï¼šæ¥æ”¶ç«¯
python3 /root/agent/receive/receiver.py --simulate &

# ç»ˆç«¯2ï¼šä¼˜åŒ–å™¨v2.2
python3 /root/agent/computer/mode_dqn_v2.py &

# ç»ˆç«¯3ï¼šå‘é€ç«¯
python3 /root/agent/send/sender.py --simulate --interval 10
```

### ç›‘æ§æ—¥å¿—

```bash
# æŸ¥çœ‹åŠ¨ä½œé€‰æ‹©
tail -f /tmp/optimizer.log | grep "DQNä¼˜åŒ–"

# ç¤ºä¾‹è¾“å‡ºï¼š
# [DQNä¼˜åŒ–] åŠ¨ä½œ=123/1064, Bundle=4000, Block=80000, Segment=600, Session=3(è®¡ç®—)
```

### åˆ†æSegmentåˆ†å¸ƒ

```bash
# ç»Ÿè®¡ä½¿ç”¨çš„segmentå€¼
grep "DQNä¼˜åŒ–" /tmp/optimizer.log | \
  grep -oP "Segment=\K\d+" | \
  sort | uniq -c | sort -rn

# é¢„æœŸçœ‹åˆ°7ç§segmentéƒ½æœ‰ä½¿ç”¨
```

---

## ğŸ”§ è°ƒä¼˜å»ºè®®

### å¦‚æœæ”¶æ•›å¤ªæ…¢

1. **å¢åŠ æ¢ç´¢ç‡**:
```python
self.epsilon = 0.2  # ä»0.1æé«˜åˆ°0.2
```

2. **å¢åŠ æ‰¹æ¬¡å¤§å°**:
```python
self.batch_size = 64  # ä»32æé«˜åˆ°64
```

3. **æé«˜å­¦ä¹ ç‡**:
```python
self.learning_rate = 0.005  # ä»0.001æé«˜åˆ°0.005
```

### å¦‚æœSegmentåˆ†å¸ƒä¸å‡

è§‚å¯Ÿæ—¥å¿—ä¸­segmentçš„ä½¿ç”¨é¢‘ç‡ï¼Œå¦‚æœæŸäº›segmentä»æœªè¢«ä½¿ç”¨ï¼š

1. **æ£€æŸ¥çº¦æŸ**: ç¡®è®¤è¯¥segmentåœ¨å“ªäº›(bundle, block)ç»„åˆä¸‹æœ‰æ•ˆ
2. **å¢åŠ æ¢ç´¢**: ä¸´æ—¶æé«˜Îµå€¼ï¼Œå¢åŠ éšæœºæ¢ç´¢
3. **æ£€æŸ¥å¥–åŠ±**: ç¡®è®¤å¥–åŠ±å‡½æ•°æ˜¯å¦åå‘æŸäº›segment

---

## ğŸ“ å…³é”®æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **[mode_dqn_v2.py](/root/agent/computer/mode_dqn_v2.py)** - v2.2ç‰ˆæœ¬
   - æ›´æ–°äº†`__init__()`
   - æ·»åŠ äº†`_generate_all_valid_3tuples()`
   - ç®€åŒ–äº†`action_to_params()`
   - åˆ é™¤äº†è‡ªé€‚åº”segmentç›¸å…³æ–¹æ³•

### æœªä¿®æ”¹çš„æ–‡ä»¶

- **sender.py**: æ— éœ€ä¿®æ”¹ï¼Œå…¼å®¹v2.2
- **receiver.py**: æ— éœ€ä¿®æ”¹ï¼Œå…¼å®¹v2.2
- **dtn_ion.py**: æ— éœ€ä¿®æ”¹

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆåŠ¨ä½œç©ºé—´æ˜¯1064ä¸ªï¼Ÿ

```
è®¡ç®—è¿‡ç¨‹ï¼š
- 15ç§bundle Ã— 20ç§block = 300ä¸ªç†è®ºç»„åˆ
- çº¦æŸè¿‡æ»¤ï¼šblock >= bundle AND block % bundle == 0
- å®é™…æœ‰æ•ˆï¼š152ä¸ª(bundle, block)ç»„åˆ
- æ¯ä¸ªç»„åˆ Ã— 7ç§segment = 1064ä¸ªä¸‰å…ƒç»„
```

### 2. ä¸ºä»€ä¹ˆä¸é‡‡æ ·å‡å°‘åŠ¨ä½œæ•°ï¼Ÿ

**åŸå› **:
- ç”¨æˆ·æ˜ç¡®è¦æ±‚"æ‰€æœ‰7ä¸ªsegmentéƒ½èƒ½è¢«è¦†ç›–åˆ°"
- é‡‡æ ·å¯èƒ½é—æ¼æŸäº›segmentå€¼
- 1064ä¸ªåŠ¨ä½œå¯¹äºDQNæ¥è¯´ä»ç„¶å¯æ§

**å¯¹æ¯”**:
- å¦‚æœé‡‡æ ·åˆ°200ä¸ªï¼šå¯èƒ½åªè¦†ç›–5-6ç§segment
- å¦‚æœé‡‡æ ·åˆ°500ä¸ªï¼šå¯èƒ½è¦†ç›–6-7ç§segment
- ä½¿ç”¨å…¨éƒ¨1064ä¸ªï¼šä¿è¯7ç§segment 100%è¦†ç›–

### 3. å¦‚ä½•ä¿è¯çº¦æŸæ»¡è¶³ï¼Ÿ

åœ¨ç”Ÿæˆé˜¶æ®µå°±è¿‡æ»¤ï¼š
```python
for bundle in bundle_sizes:
    for block in block_sizes:
        if block >= bundle and block % bundle == 0:  # çº¦æŸ1+2
            max_segment = int(block * 0.5)
            for segment in segment_sizes:
                if segment <= max_segment:  # çº¦æŸ3
                    valid_tuples.append((bundle, block, segment))
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

### v2.0 â†’ v2.1 â†’ v2.2æ¼”è¿›

| ç‰ˆæœ¬ | åŠ¨ä½œç©ºé—´ | Segmentç­–ç•¥ | ä¼˜åŠ¿ | ä¸è¶³ |
|------|---------|------------|------|------|
| v2.0 | 9 (3Ã—3) | å›ºå®šæ˜ å°„ | ç®€å•å¿«é€Ÿ | è¦†ç›–ä¸å…¨ |
| v2.1 | 32 (é‡‡æ ·) | ç½‘ç»œçŠ¶æ€è‡ªé€‚åº” | å¹³è¡¡è¦†ç›–å’Œæ•ˆç‡ | Segmentä¾èµ–è§„åˆ™ |
| v2.2 | 1064 (å…¨éƒ¨) | RLç›´æ¥å­¦ä¹  | 100%è¦†ç›–+RLå­¦ä¹  | åŠ¨ä½œç©ºé—´è¾ƒå¤§ |

---

## âœ… æ€»ç»“

### v2.2çš„æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **å®Œæ•´è¦†ç›–**: Segmentçš„7ä¸ªå€¼å…¨éƒ¨è¦†ç›–ï¼Œä¸é—æ¼
2. âœ… **RLä¼˜åŒ–**: Segmenté€‰æ‹©ç”±æ¨¡å‹å­¦ä¹ ï¼Œè€Œéå›ºå®šè§„åˆ™
3. âœ… **çº¦æŸä¿è¯**: æ‰€æœ‰1064ä¸ªåŠ¨ä½œéƒ½æ»¡è¶³3ä¸ªçº¦æŸæ¡ä»¶
4. âœ… **å‘åå…¼å®¹**: senderå’Œreceiveræ— éœ€ä¿®æ”¹

### æ¨èä½¿ç”¨åœºæ™¯

v2.2é€‚åˆï¼š
- éœ€è¦ç²¾ç¡®æ§åˆ¶segmentå¤§å°çš„åœºæ™¯
- å¸Œæœ›RLè‡ªåŠ¨å­¦ä¹ æœ€ä¼˜segmentçš„åœºæ™¯
- å¯¹è®­ç»ƒæ—¶é—´è¦æ±‚ä¸ä¸¥æ ¼çš„åœºæ™¯

### åç»­ä¼˜åŒ–æ–¹å‘

å¦‚æœ1064ä¸ªåŠ¨ä½œå¯¼è‡´è®­ç»ƒå¤ªæ…¢ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. é‡‡æ ·ç­–ç•¥ï¼šæ¯ä¸ªsegmenté‡‡æ ·3-5ä¸ª(bundle, block)ç»„åˆ â†’ ~35ä¸ªåŠ¨ä½œ
2. åˆ†å±‚RLï¼šç¬¬ä¸€å±‚é€‰(bundle, block)ï¼Œç¬¬äºŒå±‚é€‰segment
3. è¿ç»­åŠ¨ä½œç©ºé—´ï¼šå°†segmentä½œä¸ºè¿ç»­å˜é‡è€Œéç¦»æ•£é€‰æ‹©

---

**v2.2å®ç°å®Œæˆæ—¶é—´**: 2025å¹´ï¼ˆå½“å‰ï¼‰
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡çº¦æŸéªŒè¯å’Œç³»ç»ŸåŠ è½½æµ‹è¯•
**å»ºè®®**: å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ
